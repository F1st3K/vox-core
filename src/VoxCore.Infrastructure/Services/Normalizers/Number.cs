using System.Text;
using VoxCore.Runtime.Contracts;

namespace VoxCore.Infrastructure.Services.Normalizers;

public sealed class Number : ITextNormalaizer
{
    static readonly Dictionary<string, long> Numbers = new (StringComparer.OrdinalIgnoreCase)
    {
        // 0
        ["ноль"]=0, ["нуль"]=0,

        // 1
        ["один"]=1, ["одна"]=1, ["одно"]=1, ["одну"]=1,
        ["одного"]=1, ["одной"]=1, ["одним"]=1, ["одном"]=1,

        // 2
        ["два"]=2, ["две"]=2, ["двух"]=2, ["двум"]=2, ["двумя"]=2,

        // 3
        ["три"]=3, ["трех"]=3, ["трёх"]=3, ["трем"]=3, ["трём"]=3, ["тремя"]=3,

        // 4
        ["четыре"]=4, ["четырех"]=4, ["четырёх"]=4, ["четырем"]=4, ["четырём"]=4,

        // 5–9
        ["пять"]=5, ["пяти"]=5,
        ["шесть"]=6, ["шести"]=6,
        ["семь"]=7, ["семи"]=7,
        ["восемь"]=8, ["восьми"]=8,
        ["девять"]=9, ["девяти"]=9,

        // 10–19
        ["десять"]=10, ["десяти"]=10,
        ["одиннадцать"]=11,
        ["двенадцать"]=12,
        ["тринадцать"]=13,
        ["четырнадцать"]=14,
        ["пятнадцать"]=15,
        ["шестнадцать"]=16,
        ["семнадцать"]=17,
        ["восемнадцать"]=18,
        ["девятнадцать"]=19,

        // десятки
        ["двадцать"]=20,
        ["тридцать"]=30,
        ["сорок"]=40,
        ["пятьдесят"]=50,
        ["шестьдесят"]=60,
        ["семьдесят"]=70,
        ["восемьдесят"]=80,
        ["девяносто"]=90,

        // сотни
        ["сто"]=100,
        ["двести"]=200,
        ["триста"]=300,
        ["четыреста"]=400,
        ["пятьсот"]=500,
        ["шестьсот"]=600,
        ["семьсот"]=700,
        ["восемьсот"]=800,
        ["девятьсот"]=900,

        // множители
        ["тысяча"]=1_000,
        ["тысячи"]=1_000,
        ["тысяч"]=1_000,

        ["миллион"]=1_000_000,
        ["миллиона"]=1_000_000,
        ["миллионов"]=1_000_000,

        ["миллиард"]=1_000_000_000,
        ["миллиарда"]=1_000_000_000,
        ["миллиардов"]=1_000_000_000,

        ["триллион"]=1_000_000_000_000,
        ["триллиона"]=1_000_000_000_000,
        ["триллионов"]=1_000_000_000_000,

        ["квадриллион"]=1_000_000_000_000_000,
        ["квадриллиона"]=1_000_000_000_000_000,

        ["квинтиллион"]=1_000_000_000_000_000_000,
        ["квинтиллиона"]=1_000_000_000_000_000_000,
    };

    public async Task<string> NormalizeAsync(string text, CancellationToken ct)
    {
        var words = text.Split(' ');
        var result = new StringBuilder();

        long current = 0;
        long total = 0;
        bool building = false;

        void Flush()
        {
            if (building)
            {
                result.Append(total + current);
                result.Append(' ');
                current = 0;
                total = 0;
                building = false;
            }
        }

        foreach (var raw in words)
        {
            var word = raw
                .ToLower()
                .Trim(',', '.', '!', '?', ';', ':');

            if (Numbers.TryGetValue(word, out long value))
            {
                building = true;

                if (value >= 1000)
                {
                    if (current == 0)
                        current = 1;

                    current *= value;
                    total += current;
                    current = 0;
                }
                else
                {
                    current += value;
                }
            }
            else
            {
                Flush();
                result.Append(raw);
                result.Append(' ');
            }
        }

        Flush();
        return result.ToString().TrimEnd();
    }
}